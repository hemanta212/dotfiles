#!/bin/bash
# SSH Reverse Tunnel - Manual control with auto-retry
# Usage: mac-tunnel [start|stop|status|logs]

VPS_HOST="vps"
VPS_PORT="6969"
LOG_DIR="$HOME/.cache/scripts/mac-tunnel"
mkdir -p "$LOG_DIR"

TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
PID_FILE="$LOG_DIR/tunnel.pid"
MONITOR_PID_FILE="$LOG_DIR/monitor.pid"
LOG_FILE="$LOG_DIR/${TIMESTAMP}.log"
CURRENT_LOG="$LOG_DIR/current.log"
ERROR_LOG="$LOG_DIR/${TIMESTAMP}.error.log"
RETRY_COUNT_FILE="$LOG_DIR/retries"
STOP_FLAG="$LOG_DIR/.stop"

GREEN='\033[0;32m'; RED='\033[0;31m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }

is_tunnel_running() {
    [ -f "$PID_FILE" ] && ps -p "$(cat $PID_FILE)" > /dev/null 2>&1
}

is_monitor_running() {
    [ -f "$MONITOR_PID_FILE" ] && ps -p "$(cat $MONITOR_PID_FILE)" > /dev/null 2>&1
}

check_network() {
    ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1
}

start_ssh_connection() {
    log "Establishing SSH tunnel"
    ssh -N -R ${VPS_PORT}:localhost:22 \
        -o ServerAliveInterval=30 \
        -o ServerAliveCountMax=3 \
        -o ExitOnForwardFailure=yes \
        -o ConnectTimeout=10 \
        -o TCPKeepAlive=yes \
        "$VPS_HOST" >> "$LOG_FILE" 2>> "$ERROR_LOG" &
    echo $! > "$PID_FILE"
}

monitor_loop() {
    echo "0" > "$RETRY_COUNT_FILE"
    rm -f "$STOP_FLAG"
    log "Monitor started"
    
    while true; do
        [ -f "$STOP_FLAG" ] && { log "Stop requested"; rm -f "$STOP_FLAG"; break; }
        
        if ! is_tunnel_running; then
            RETRY_COUNT=$(cat "$RETRY_COUNT_FILE" 2>/dev/null || echo "0")
            
            # Exponential backoff: 0s, 10s, 20s, 40s, 80s, max 300s
            DELAY=0
            [ "$RETRY_COUNT" -gt 0 ] && DELAY=$((10 * (2 ** (RETRY_COUNT - 1))))
            [ "$DELAY" -gt 300 ] && DELAY=300
            
            [ "$DELAY" -gt 0 ] && { log "Retry #$RETRY_COUNT - waiting ${DELAY}s"; sleep "$DELAY"; }
            
            # Check network before retry
            if ! check_network; then
                log "No network, waiting 30s"
                sleep 30
                echo $((RETRY_COUNT + 1)) > "$RETRY_COUNT_FILE"
                continue
            fi
            
            log "Attempt #$((RETRY_COUNT + 1))"
            start_ssh_connection
            echo $((RETRY_COUNT + 1)) > "$RETRY_COUNT_FILE"
            sleep 3
            
            # Reset counter after 5min stable
            is_tunnel_running && {
                log "Connected (PID: $(cat $PID_FILE))"
                (sleep 300; is_tunnel_running && { echo "0" > "$RETRY_COUNT_FILE"; log "Stable 5min, reset counter"; }) &
            }
        fi
        sleep 10
    done
    rm -f "$MONITOR_PID_FILE"
}

start() {
    is_monitor_running && { echo -e "${YELLOW}Already running${NC}"; return 1; }
    rm -f "$STOP_FLAG" "$PID_FILE" "$MONITOR_PID_FILE"
    # Create new log file for this session
    TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
    LOG_FILE="$LOG_DIR/${TIMESTAMP}.log"
    ERROR_LOG="$LOG_DIR/${TIMESTAMP}.error.log"
    ln -sf "$LOG_FILE" "$CURRENT_LOG"
    echo -e "${GREEN}Starting tunnel...${NC}"
    log "Start requested"
    monitor_loop & echo $! > "$MONITOR_PID_FILE"
    sleep 3
    is_monitor_running && {
        echo -e "${GREEN}Started${NC} - Connect: ${BLUE}ssh -p ${VPS_PORT} mac@vps.osac.org.np${NC}"
        echo -e "Log: ${BLUE}$LOG_FILE${NC}"
    } || echo -e "${RED}Failed${NC}"
}

stop() {
    is_monitor_running || { echo -e "${YELLOW}Not running${NC}"; return 1; }
    echo -e "${YELLOW}Stopping...${NC}"
    log "Stop requested"
    kill "$(cat $MONITOR_PID_FILE 2>/dev/null)" 2>/dev/null
    is_tunnel_running && kill "$(cat $PID_FILE)" 2>/dev/null
    rm -f "$PID_FILE" "$MONITOR_PID_FILE" "$STOP_FLAG"
    echo -e "${GREEN}Stopped${NC}"
}

status() {
    if is_monitor_running; then
        echo -e "Monitor:   ${GREEN}Running${NC} (PID: $(cat $MONITOR_PID_FILE))"
        is_tunnel_running && echo -e "Tunnel:    ${GREEN}Connected${NC} (PID: $(cat $PID_FILE))" || echo -e "Tunnel:    ${YELLOW}Reconnecting${NC}"
        echo -e "Retries:   $(cat $RETRY_COUNT_FILE 2>/dev/null || echo 0)"
        echo -e "Port:      VPS:${VPS_PORT} -> Mac:22"
        echo -e "Connect:   ${BLUE}ssh -p ${VPS_PORT} mac@vps.osac.org.np${NC}"
        echo -e "Log:       ${BLUE}$CURRENT_LOG${NC}"
    else
        echo -e "Status:    ${RED}Not running${NC}"
        echo -e "Start:     ${YELLOW}mac-tunnel start${NC}"
    fi
}

logs() {
    case "$1" in
        error) tail -f "$LOG_DIR"/*.error.log 2>/dev/null ;;
        -f|follow) tail -f "$CURRENT_LOG" ;;
        *) tail -30 "$CURRENT_LOG" 2>/dev/null || ls -la "$LOG_DIR" ;;
    esac
}

case "${1:-status}" in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 2; start ;;
    status) status ;;
    logs) logs "${2}" ;;
    help|--help|-h)
        echo "Usage: mac-tunnel [start|stop|restart|status|logs [-f|error]]"
        echo ""
        echo "Features: Manual control, auto-reconnect, exponential backoff, network checks"
        echo "Tunnel:   Mac:22 -> VPS:${VPS_PORT}"
        echo "Connect:  ssh -p ${VPS_PORT} mac@vps.osac.org.np"
        echo "Logs:     $LOG_DIR/"
        ;;
    *) echo -e "${RED}Unknown: $1${NC}"; exit 1 ;;
esac
