#!/usr/bin/env bash
# Summary: Cross-links related PRs across repos by branch name.
# Description:
# Finds all open PRs by an author matching a given branch ID across all repos.
# If 2+ PRs match, updates each PR body with a "Related PRs" section linking to the others.
# Runs searches and updates in parallel for speed. Idempotent - safe to re-run.
# Appends a footer crediting linkprs with a link to the source script.

set -euo pipefail

BRANCH_ID="${1:-}"
AUTHOR="${2:-$(gh api user --jq '.login' 2>/dev/null)}"

if [[ -z "$BRANCH_ID" ]]; then
    echo "Usage: $0 <branch-id> [author]"
    echo "Example: $0 ISSUE-14334 hemanta212"
    exit 1
fi

TMP_DIR=$(mktemp -d)
trap "rm -rf $TMP_DIR" EXIT

echo "Finding repos with open PRs by '$AUTHOR'..."

# Get all repos where author has open PRs
REPOS=$(gh search prs --author="$AUTHOR" --state=open --json repository --limit 200 2>/dev/null | jq -r '.[].repository.nameWithOwner' | sort -u)

echo "Searching for branch '$BRANCH_ID' across $(echo "$REPOS" | wc -l | tr -d ' ') repos..."

# Parallel fetch all repos
for repo in $REPOS; do
    (
        result=$(gh pr list --author="$AUTHOR" --state=open --json url,headRefName -R "$repo" 2>/dev/null || echo "[]")
        url=$(echo "$result" | jq -r --arg branch "$BRANCH_ID" '.[] | select(.headRefName == $branch) | .url' 2>/dev/null || true)
        if [[ -n "$url" ]]; then
            repo_name=$(basename "$repo")
            echo "${repo_name}|${url}" > "$TMP_DIR/$repo_name"
            echo "  Found: $repo_name -> $url"
        fi
    ) &
done
wait

# Collect results
PR_DATA=$(cat "$TMP_DIR"/* 2>/dev/null || true)
PR_COUNT=$(echo -n "$PR_DATA" | grep -c '|' || echo 0)

if [[ "$PR_COUNT" -lt 2 ]]; then
    echo "Found $PR_COUNT PR(s). Need at least 2 to link."
    exit 0
fi

echo "Found $PR_COUNT PRs. Updating PR bodies..."

FOOTER='---
*<sub>generated by [linkprs](https://github.com/hemanta212/dotfiles/blob/master/scripts/linkprs)</sub>*'

# Parallel update all PRs
echo "$PR_DATA" | while IFS='|' read -r current_repo current_url; do
    [[ -z "$current_url" ]] && continue
    (
        # Build related links
        related_content=$(echo "$PR_DATA" | while IFS='|' read -r other_repo other_url; do
            [[ -z "$other_url" || "$other_url" == "$current_url" ]] && continue
            display_name=$(echo "$other_repo" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1' | sed 's/ /-/g')
            echo "* **${display_name}**: ${other_url}"
        done)
        
        new_section="## Related PRs:
${related_content}

${FOOTER}"
        
        current_body=$(gh pr view "$current_url" --json body -q '.body' 2>/dev/null || echo "")
        
        # Strip existing Related PRs section
        clean_body=$(echo "$current_body" | awk '
            /^## Related PRs:/ { in_section=1; next }
            in_section && /generated by \[linkprs\]/ { in_section=0; next }
            !in_section { print }
        ' | sed '/^[[:space:]]*$/{N;s/^\n$//;}' | sed '1{/^$/d;}')
        
        new_body="${new_section}

${clean_body}"
        
        echo "$new_body" | gh pr edit "$current_url" --body-file -
        echo "  Updated: $current_repo"
    ) &
done
wait

echo "Done! All $PR_COUNT PRs linked."
