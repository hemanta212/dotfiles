#!/bin/bash
# piper-say - Quick English TTS using Piper HTTP Server
# Usage: piper-say "Your English text here"

set -euo pipefail

PIPER_DIR="/Users/mac/.config/piper"
MODEL_NAME="en_US-libritts_r-medium"
MODEL_PATH="$PIPER_DIR/${MODEL_NAME}.onnx"
CONFIG_PATH="$PIPER_DIR/${MODEL_NAME}.onnx.json"
MUTE_FILE="$PIPER_DIR/.muted"
VOLUME_FILE="$PIPER_DIR/.volume"
NOTIF_FILE="$PIPER_DIR/.notifs_enabled"
LOG_FILE="$PIPER_DIR/piper-say.log"
PID_FILE="$PIPER_DIR/.piper-server.pid"
SERVER_HOST="127.0.0.1"
SERVER_PORT=5656
SPEAKER_ID=0

log_invocation() {
  local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  local cwd=$(pwd)
  local args="$*"
  local log_entry="[$timestamp] CWD: $cwd | ARGS: $args"

  mkdir -p "$PIPER_DIR"
  echo "$log_entry" >>"$LOG_FILE"
  tail -10 "$LOG_FILE" >"$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
}

send_notification() {
  local message="$1"
  osascript -e "display notification \"$message\" with title \"Piper Say\""
}

check_server_health() {
  curl -s -f "http://${SERVER_HOST}:${SERVER_PORT}/voices" >/dev/null 2>&1
}

is_port_in_use() {
  lsof -i ":${SERVER_PORT}" -sTCP:LISTEN >/dev/null 2>&1
}

start_server() {
  if [ ! -f "$MODEL_PATH" ] || [ ! -f "$CONFIG_PATH" ]; then
    echo "Error: Piper model files not found in $PIPER_DIR" >&2
    echo "Expected files:" >&2
    echo "  - ${MODEL_NAME}.onnx" >&2
    echo "  - ${MODEL_NAME}.onnx.json" >&2
    return 1
  fi

  ~/.local/pipx/venvs/piper-tts/bin/python -m piper.http_server \
    --host "$SERVER_HOST" \
    --port "$SERVER_PORT" \
    -m "$MODEL_NAME" \
    --data-dir "$PIPER_DIR" \
    >/dev/null 2>&1 &
  
  local pid=$!
  echo "$pid" > "$PID_FILE"
  
  sleep 1
  
  if check_server_health; then
    return 0
  else
    rm -f "$PID_FILE"
    return 1
  fi
}

ensure_server_running() {
  if [ -f "$PID_FILE" ]; then
    local pid=$(cat "$PID_FILE")
    if ps -p "$pid" >/dev/null 2>&1; then
      if check_server_health; then
        return 0
      else
        kill "$pid" 2>/dev/null || true
        rm -f "$PID_FILE"
      fi
    else
      rm -f "$PID_FILE"
    fi
  fi

  if is_port_in_use; then
    if check_server_health; then
      return 0
    else
      echo "Error: Port $SERVER_PORT is occupied by another process" >&2
      return 1
    fi
  fi

  start_server
}

stop_server() {
  if [ -f "$PID_FILE" ]; then
    local pid=$(cat "$PID_FILE")
    if ps -p "$pid" >/dev/null 2>&1; then
      kill "$pid" 2>/dev/null || true
      sleep 0.5
      if ps -p "$pid" >/dev/null 2>&1; then
        kill -9 "$pid" 2>/dev/null || true
      fi
    fi
    rm -f "$PID_FILE"
    echo "Piper server stopped."
  else
    echo "No server PID file found."
  fi
}

if [ $# -eq 1 ] && [[ "$1" =~ ^(--help|help|h|-h)$ ]]; then
  cat <<'EOF'
piper-say - Quick English TTS using Piper HTTP Server

USAGE:
  piper-say "Your English text here"
  piper-say [COMMAND] [OPTIONS]

COMMANDS:
  m, --mute         Mute all future piper-say calls (fallback to notifs if enabled)
  u, --unmute       Unmute piper-say (disables notification fallback)
  q, --notif        Toggle notification fallback on/off when muted
  l, --log          Show last 10 invocations
  v, --volume NUM   Set persistent volume (0-100)
  stop              Stop the background HTTP server
  h, --help         Show this help message

EXAMPLES:
  Basic usage:
    piper-say "Hello World"
    piper-say "Task completed successfully"

  Mute/unmute:
    piper-say m                    # Mute all future calls
    piper-say u                    # Unmute (also disables notif fallback)

  Notification fallback (when muted):
    piper-say q                    # Toggle notif fallback on/off

  Volume control:
    piper-say v 50                 # Set volume to 50%
    piper-say v 100                # Set volume to 100%

  View logs:
    piper-say l                    # Show last 10 invocations

  Server management:
    piper-say stop                 # Stop background server

  In scripts:
    make build && piper-say "Build complete"
    piper-say "Starting server" && npm start

FEATURES:
  - HTTP server daemon (auto-starts on first use)
  - Background audio playback (non-blocking)
  - Persistent volume control
  - Mute/unmute toggle
  - Notification fallback when muted
  - Invocation logging
  - Automatic cleanup of temporary files

SERVER:
  Host:       127.0.0.1
  Port:       5656
  Start:      ~/.local/pipx/venvs/piper-tts/bin/python -m piper.http_server
  PID file:   /Users/mac/.config/piper/.piper-server.pid

FILES:
  Models:     /Users/mac/.config/piper/en_US-libritts_r-medium.onnx
  Config:     /Users/mac/.config/piper/en_US-libritts_r-medium.onnx.json
  Mute state: /Users/mac/.config/piper/.muted
  Notif state:/Users/mac/.config/piper/.notifs_enabled
  Volume:     /Users/mac/.config/piper/.volume
  Logs:       /Users/mac/.config/piper/piper-say.log

NOTES:
  - For Nepali TTS, use 'piper-sayn' instead
  - HTTP server starts automatically and persists between calls
  - Volume setting persists across all piper-say calls
  - Audio plays in background and doesn't block terminal
EOF
  exit 0
fi

if [ $# -eq 1 ] && [[ "$1" =~ ^(stop)$ ]]; then
  stop_server
  exit 0
fi

if [ $# -eq 1 ] && [[ "$1" =~ ^(--log|log|l)$ ]]; then
  if [ -f "$LOG_FILE" ]; then
    echo "Last 10 piper-say invocations:"
    cat "$LOG_FILE"
  else
    echo "No log entries found."
  fi
  exit 0
fi

if [ $# -eq 1 ] && [[ "$1" =~ ^(--mute|m)$ ]]; then
  log_invocation "$@"
  mkdir -p "$PIPER_DIR"
  touch "$MUTE_FILE"
  touch "$NOTIF_FILE"
  echo "Piper-say muted. Notification fallback enabled. Use 'piper-say u' to unmute or 'piper-say q' to toggle notifs."
  exit 0
elif [ $# -eq 1 ] && [[ "$1" =~ ^(--unmute|u)$ ]]; then
  log_invocation "$@"
  rm -f "$MUTE_FILE"
  rm -f "$NOTIF_FILE"
  echo "Piper-say unmuted. Notification fallback disabled."
  exit 0
elif [ $# -eq 1 ] && [[ "$1" =~ ^(--notif|q)$ ]]; then
  log_invocation "$@"
  mkdir -p "$PIPER_DIR"
  if [ -f "$NOTIF_FILE" ]; then
    rm -f "$NOTIF_FILE"
    echo "Notification fallback disabled."
  else
    touch "$NOTIF_FILE"
    echo "Notification fallback enabled."
  fi
  exit 0
fi

if [ $# -eq 2 ] && [[ "$1" =~ ^(--volume|v)$ ]]; then
  VOLUME="$2"

  if ! [[ "$VOLUME" =~ ^[0-9]+$ ]] || [ "$VOLUME" -lt 0 ] || [ "$VOLUME" -gt 100 ]; then
    echo "Error: Volume must be between 0-100" >&2
    exit 1
  fi

  log_invocation "$@"
  mkdir -p "$PIPER_DIR"
  echo "$VOLUME" >"$VOLUME_FILE"
  echo "Volume set to $VOLUME% for all future piper-say calls."
  exit 0
fi

if [ $# -gt 0 ] && ! [[ "$1" =~ ^(--log|log|l)$ ]]; then
  log_invocation "$@"
fi

if [ -f "$MUTE_FILE" ]; then
  if [ -f "$NOTIF_FILE" ] && [ -n "${1:-}" ]; then
    send_notification "$1"
  fi
  exit 0
fi

if [ $# -eq 0 ] || [ -z "${1:-}" ]; then
  echo "Usage: piper-say \"Your English text here\"" >&2
  echo "       piper-say --help    # Show detailed help" >&2
  exit 1
fi

if ! ensure_server_running; then
  echo "Error: Failed to start Piper HTTP server" >&2
  exit 1
fi

TEMP_AUDIO=$(mktemp -t piper-say).wav
trap "rm -f '$TEMP_AUDIO'" EXIT

if ! curl -s -X POST \
  -H 'Content-Type: application/json' \
  -d "{\"text\": $(printf '%s' "$1" | jq -Rs .), \"speaker_id\": $SPEAKER_ID}" \
  -o "$TEMP_AUDIO" \
  "http://${SERVER_HOST}:${SERVER_PORT}" 2>/dev/null; then
  echo "Error: Failed to generate TTS audio" >&2
  exit 1
fi

play_audio() {
  local audio_file="$1"
  if command -v afplay >/dev/null 2>&1; then
    afplay "$audio_file"
  elif command -v ffplay >/dev/null 2>&1; then
    ffplay -nodisp -autoexit "$audio_file" 2>/dev/null
  elif command -v aplay >/dev/null 2>&1; then
    aplay "$audio_file" 2>/dev/null
  else
    echo "Warning: No audio player found. Audio saved temporarily at: $audio_file" >&2
    echo "Install ffplay, afplay (macOS), or aplay (Linux) to play audio directly." >&2
    return 1
  fi
  rm -f "$audio_file"
}

if [ -f "$VOLUME_FILE" ]; then
  SAVED_VOLUME=$(cat "$VOLUME_FILE")
  CURRENT_VOLUME=$(osascript -e "output volume of (get volume settings)")
  osascript -e "set volume output volume $SAVED_VOLUME"
  USE_SAVED_VOLUME=1
fi

if [ "${USE_SAVED_VOLUME:-}" = "1" ]; then
  nohup bash -c "$(declare -f play_audio); play_audio '$TEMP_AUDIO'; sleep 1; osascript -e 'set volume output volume $CURRENT_VOLUME'" >/dev/null 2>&1 &
else
  nohup bash -c "$(declare -f play_audio); play_audio '$TEMP_AUDIO'" >/dev/null 2>&1 &
fi
disown

trap - EXIT
