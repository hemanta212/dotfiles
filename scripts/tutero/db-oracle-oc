#!/usr/bin/env bash
set -euo pipefail

db=""
dirs=()
verbose=false
show_help=false

while [[ $# -gt 0 ]]; do
  case $1 in
  -db)
    db="$2"
    shift 2
    ;;
  -v)
    verbose=true
    shift
    ;;
  --dirs)
    shift
    while [[ $# -gt 0 && ! "$1" =~ ^- ]]; do
      dirs+=("$1")
      shift
    done
    ;;
  --help | -h)
    show_help=true
    shift
    ;;
  *)
    echo "Error: Unexpected argument '$1'. Prompt must be provided via stdin." >&2
    exit 1
    ;;
  esac
done

if [ "$show_help" = true ]; then
  cat <<'EOF'
Usage: db-oracle-oc -db <resources|learning|teaching> [-v] [--dirs <dir1> <dir2> ...]

Arguments:
  -db <name>        Database to query (required): resources, learning, or teaching
  -v                Verbose mode (show live output)
  --dirs <dirs...>  Additional directories to reference in the prompt
  --help, -h        Show this help message

Note: Prompt must be provided via stdin (pipe or redirect)

Examples:
  # Pipe from stdin
  echo "List all courses" | db-oracle-oc -db learning
  
  # Pipe file content
  cat query.txt | db-oracle-oc -db teaching
  
  # With additional context directories
  cat prompt.txt | db-oracle-oc -db resources --dirs backend/app frontend/src
  
  # Multi-line heredoc
  db-oracle-oc -db resources <<EOF
  Show me all students enrolled in math courses
  Include their grades
  EOF

EOF
  exit 0
fi

if [ -z "$db" ]; then
  repo_name=$(basename "$(git rev-parse --show-toplevel 2>/dev/null || echo "unknown")")
  echo "Error: -db argument is required" >&2
  echo "Usage: echo \"prompt\" | $(basename "$0") -db <resources|learning|teaching> [-v] [--dirs <dir1> <dir2> ...]" >&2
  echo "Hint: The full pwd path, you're working on might give a clue, you're currently in repo: '$repo_name'" >&2
  exit 1
fi

if [[ ! "$db" =~ ^(resources|learning|teaching)$ ]]; then
  echo "Error: -db must be one of: resources, learning, teaching" >&2
  exit 1
fi

if [ -t 0 ]; then
  echo "Error: Prompt must be provided via stdin (pipe or redirect)" >&2
  echo "Usage: echo \"prompt\" | $(basename "$0") -db <resources|learning|teaching> [-v] [--dirs <dir1> <dir2> ...]" >&2
  exit 1
fi

piped_input=$(cat)

LOG_DIR="${HOME}/.cache/scripts/oracle-logs"
mkdir -p "$LOG_DIR"

timestamp="$(date "+%Y%m%dT%H%M%S")"
log_file="$LOG_DIR/${timestamp}-$$.log"

final_prompt=""

if [ ${#dirs[@]} -gt 0 ]; then
  final_prompt="Referenced Project/Repositories directories:"$'\n'
  for dir in "${dirs[@]}"; do
    final_prompt="${final_prompt}- ${dir}"$'\n'
  done
  final_prompt="${final_prompt}"$'\n'
fi

final_prompt="${final_prompt}${piped_input}"

args=("$final_prompt")

cd "$HOME/Coding/metarepo"

set +e
if [ "$verbose" = true ]; then
  opencode run --agent db-oracle "${args[@]}" 2>"${log_file}.tmp"
  exit_code=$?
else
  opencode run --agent db-oracle "${args[@]}" 2>"${log_file}.tmp"
  exit_code=$?
fi
set -e

# Filter out binary data from log file
strings "${log_file}.tmp" > "$log_file"
rm -f "${log_file}.tmp"

if [ $exit_code -eq 0 ]; then
  if [ "$verbose" = false ]; then
    cat "$log_file"
  fi

  # TODO// opencode specific sesson extraction, use --print-logs then grep from INFO logs
  # session_id="$(grep -oE 'Session: [[:alnum:]-]+' "$log_file" | cut -d' ' -f2)"
  # if [ -n "$session_id" ]; then
  #   printf "\nThis was part of session '%s' provide -s %s if you wanna followup\n" "$session_id" "$session_id"
  # fi
else
  cat "$log_file"
fi

exit "$exit_code"
