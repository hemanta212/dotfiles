#!/usr/bin/env bash
# Summary: Simpler codex wrapper tuned to the current project with low reasoning.
# Description:
# Runs codex exec from the invoking folder with model_reasoning_effort defaulting to low.
# Accepts --session to resume existing conversations and -r to raise reasoning effort.
# Captures output to ~/.cache/scripts/project-oracle logs and echoes follow-up commands when done.
# Prints log paths and cleans up temporary output files after each run.

set -euo pipefail

# Capture the directory from which this script was invoked
INVOKE_DIR="$(pwd)"

# Parse flags
session_id=""
reasoning="low"
while [[ $# -gt 0 ]]; do
  case $1 in
  --help | -h)
    echo "Usage: $(basename "$0") [-s|--session SESSION_ID] \"prompt\"" >&2
    echo "   or: echo \"prompt\" | $(basename "$0") [-s|--session SESSION_ID]" >&2
    echo "   or: $(basename "$0") [-s|--session SESSION_ID] <<EOF" >&2
    echo "       prompt text here" >&2
    echo "       EOF" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  -s, --session SESSION_ID    Resume an existing codex session" >&2
    echo "  -h, --help                  Show this help message" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  project-oracle \"analyze this codebase\"" >&2
    echo "  echo \"refactor the auth module\" | project-oracle" >&2
    echo "  project-oracle -s abc123 <<EOF" >&2
    echo "  continue from where we left off" >&2
    echo "  EOF" >&2
    exit 0
    ;;
  -s | --session)
    session_id="$2"
    shift 2
    ;;
  -r)
    reasoning="$2"
    if [[ ! "$reasoning" =~ ^(low|medium|high)$ ]]; then
      echo "Error: -r must be one of: low, medium, high" >&2
      exit 1
    fi
    shift 2
    ;;
  *)
    break
    ;;
  esac
done

# Read prompt from stdin if available, otherwise use arguments
if [ -t 0 ]; then
  # stdin is a terminal (no pipe/heredoc), use arguments
  if [ $# -eq 0 ]; then
    echo "Usage: $(basename "$0") [-s|--session SESSION_ID] \"prompt\"" >&2
    echo "   or: echo \"prompt\" | $(basename "$0") [-s|--session SESSION_ID]" >&2
    echo "   or: $(basename "$0") [-s|--session SESSION_ID] <<EOF" >&2
    echo "       prompt text here" >&2
    echo "       EOF" >&2
    echo "" >&2
    echo "Use --help for more information" >&2
    exit 1
  fi
  prompt="$*"
else
  # stdin has data (pipe or heredoc), read it
  prompt="$(cat)"
  if [ -z "$prompt" ]; then
    echo "Error: No prompt provided" >&2
    exit 1
  fi
fi

# Setup logging
LOG_DIR="${HOME}/.cache/scripts/project-oracle"
mkdir -p "$LOG_DIR"

timestamp="$(date "+%Y%m%dT%H%M%S")"
log_file="$LOG_DIR/${timestamp}-$$.log"
output_file="/tmp/project-oracle-output-$$.txt"

# Execute codex with the detected directory
set +e
if [ -n "$session_id" ]; then
  # Resume existing session
  codex exec \
    --skip-git-repo-check \
    --config model_reasoning_effort="$reasoning" \
    --cd "$INVOKE_DIR" \
    --output-last-message "$output_file" \
    resume "$session_id" \
    "$prompt" \
    >"$log_file" 2>&1
  exit_code=$?
else
  # Start new session
  codex exec \
    --skip-git-repo-check \
    --config model_reasoning_effort="$reasoning" \
    --cd "$INVOKE_DIR" \
    --output-last-message "$output_file" \
    "$prompt" \
    >"$log_file" 2>&1
  exit_code=$?
fi
set -e

# Handle output
if [ $exit_code -eq 0 ]; then
  cat "$output_file"

  # Extract and display session ID for follow-ups
  extracted_session_id="$(grep -oE 'session id: [[:alnum:]-]+' "$log_file" | cut -d' ' -f3)"
  if [ -n "$extracted_session_id" ]; then
    printf "\n--------------\nTo follow up on this conversation! use the command: project-oracle -s %s <prompt via pipe|heredoc>\n" "$extracted_session_id"
  fi

  # Show where logs are stored
  printf "[debug] Logs saved to: %s\n" "$log_file" >&2
else
  # On error, show the full logs
  cat "$log_file"
  printf "\n[debug] Logs saved to: %s\n" "$log_file" >&2
fi

# Cleanup temp file
rm -f "$output_file"

exit "$exit_code"
