alias ed='emacsclient -a "" -c -nw'
alias hg='history | grep'
# Alias for uploading with a secret to make the URL harder to guess
alias pb="curl -F 'file=@-' -F 'secret=' https://0x0.st"
# Alias for uploading with a secret and setting expiration to 24 hours
alias pb24="curl -F 'file=@-' -F 'secret=' -F 'expires=24' https://0x0.st"
alias pg='ping google.com'
alias memfree='echo "sync && echo 3 > /proc/sys/vm/drop_caches" | sudo sh'
alias cat='bat'
alias ytdl='youtube-dl'
alias stinfo='~/.termux/api_info.py all'
alias si='sudo apt install'
alias Ss='sudo apt search'
alias Su='sudo apt update'
alias Syu='sudo apt update && sudo apt upgrade -y'
alias syu='sudo apt update && sudo apt upgrade'
alias gcloud='~/google-cloud-sdk/bin/gcloud'
alias tele='telepresence'
code() {
    /Applications/Visual\ Studio\ Code.app/Contents/MacOS/Electron "$@" > /dev/null 2>&1 &
}
run() {
  ./run
}
telec() {
  local lock_dir="/tmp/telec.lock"

  # if r arg is passed, we're recursing
  [ "$1" = "r" ] && { isRecursing=true; shift; } || isRecursing=false

  # Ensure only one telec invocation runs at a time
  if ! mkdir "${lock_dir}" 2>/dev/null; then
    # only echo first time not in recursion
    [ "$isRecursing" = false ] && echo " lockfile: $lock_dir exists ..."
    sleep 1
    telec r "$@"
    return
  fi
  # Check if the service is reachable
  if curl -sSf "http://resources-neo4j-db-lb-neo4j.learning.svc.cluster.local:7474/browser/" > /dev/null; then
    echo ":: telepresence check ✅ Already connected"
  else
    echo ":: telepresence check ❌ Reconnecting..."
    # Quit existing Telepresence session if any and reconnect
    telepresence quit -s
    # Set the Kubernetes context to dev
    current_context=$(kubectl config current-context)
    kubectl config use-context dev
    telepresence connect
  fi
  rmdir "${lock_dir}"
}
kneo() {
     # k port-forward --context=prod -n learning pod/learning-neo4j-2-0 7687:7687 7474:7474
     # Take first arg context eg "prod", second arg neo4j prefix eg "learning"
     # and port arg eg 87 converts to 7687 (implies frontend port 7474), 88 -> 7688 (implies frontend 7475) and so on
     # if no port arg default to 7687
      local context="$1"
      local prefix="$2"
      local port="${3:-87}"
      port=$((port + 7600))
      local port_7474=$((port - 213)) # 7687 -> 7474, 7688 -> 7475, etc.
      if [ -z "$context" ] || [ -z "$prefix" ]; then
        echo "Usage: kneo <context> <prefix> [port]"
        return 1
      fi
      echo ":: Running kubectl port-forward --context=$context -n learning pod/${prefix}-neo4j-3-0 $port:7687 $port_7474:7474"
      kubectl port-forward --context="$context" -n "learning" pod/"${prefix}"-neo4j-2-0 "$port":7687 "$port_7474":7474
}
kport() {
    local PREFIX=$1
    local CONTEXT=$2
    shift 2

    if [[ -z "$PREFIX" || -z "$CONTEXT" || $# -eq 0 ]]; then
        echo "Usage: kport <prefix> <context> <local1:remote1> [<local2:remote2> ...]"
        return 1
    fi

    # Find the pod and namespace
    POD_INFO=$(kubectl get pods --context="$CONTEXT" --all-namespaces --no-headers -o custom-columns="NAMESPACE:.metadata.namespace,NAME:.metadata.name" | grep "$PREFIX" | head -n 1)

    if [[ -z "$POD_INFO" ]]; then
        echo "No pod found with prefix '$PREFIX' in any namespace under context '$CONTEXT'"
        return 1
    fi

    local NAMESPACE=$(echo "$POD_INFO" | awk '{print $1}')
    local POD_NAME=$(echo "$POD_INFO" | awk '{print $2}')

    # Build the port-forward arguments
    local PORT_ARGS=()
    for pair in "$@"; do
        if [[ "$pair" != *:* ]]; then
            echo "Invalid port format: $pair. Use <local>:<remote>"
            return 1
        fi
        PORT_ARGS+=("$pair")
    done

    echo "Port forwarding pod $POD_NAME in namespace $NAMESPACE (context: $CONTEXT):"
    printf ' - %s\n' "${PORT_ARGS[@]}"

    kubectl port-forward --context="$CONTEXT" -n "$NAMESPACE" pod/"$POD_NAME" "${PORT_ARGS[@]}"
}

alias k='kubectl'
alias py='.venv/bin/python'
alias venv='source .venv/bin/activate'
#alias changelog="git log --pretty=format:'%s' $(git describe --tags --abbrev=0 @^)..@"

alias Ss='apt search'
alias Syu='sudo apt-get update && sudo apt-get upgrade -y'
alias syu='sudo apt-get update && sudo apt-get upgrade'
alias su='sudo apt-get update'
alias si='sudo apt-get install'

alias prp='poetry run python'
alias prpp='poetry run python -m pip'
alias pr='poetry run'

alias ldc='cd $HOME/dev/tutero/flutter/learning/ && docker compose -f docker-compose-telepresence.yml up --build learning-graphql'
alias ldcl='cd $HOME/dev/tutero/flutter/learning/ && docker compose -f docker-compose.yml up --build learning-db'

alias ll='ls -alF'
alias la='ls -A'
#alias l='ls -CF'
alias l='facad'
alias infras='cd ~/dev/tutero/flutter/infrastructure/ && docker compose -f docker-compose.yml up redpanda keydb qdrant --build'
alias localdb='cd ~/dev/tutero/flutter/learning/ && docker compose -f docker-compose.yml up learning-db learning-latex learning-grpc --build -d'
alias locallearning='cd ~/dev/tutero/flutter/learning/ && docker compose -f docker-compose.yml up learning-graphql --build'
alias diag='cd ~/dev/tutero/flutter/diagnostics/ && docker compose -f docker-compose.yml up diagnostics-db --build -d; sleep 15; docker compose -f docker-compose.yml up diagnostics-grpc --build'
alias diagdb='cd ~/dev/tutero/flutter/diagnostics/ && docker compose -f docker-compose.yml up diagnostics-db --build -d'
alias gtg="graphql-tooling generate; find ./transport/graph/resolvers -name '*.resolvers.go' | xargs gofumpt -w"
alias ctg='cagen; find ./internal -name "*.go" | xargs gofumpt -w'
alias coc="COCKROACH_SKIP_ENABLING_DIAGNOSTIC_REPORTING=true cockroach"

# Flutter stuffs
alias go='/usr/local/go/bin/go'
alias f='fvm flutter'
alias d='fvm dart'
alias frcenv="env CHROME_EXECUTABLE=$HOME/.local/bin/flutter-chrome fvm"
alias fpg="frcenv flutter pub get"
alias fpu="frcenv flutter pub upgrade"
alias frc="frcenv flutter run -d chrome --web-port 5000"
#alias frcc="frcenv flutter run -d chrome --web-port 5000"
alias frcf="frc | grep --line-buffered -F '[WTF]'" # Focused frc filtering only wtf logs
alias frcp="frcenv flutter run -d chrome --web-port"
#alias frw="frcenv flutter run -d web-server --web-port 5000"
#alias fre="frcenv flutter run -d edge --web-port 5000"
alias frdsp="frcenv flutter run -d chrome --web-browser-flag '--disable-web-security' --web-port 5000"
alias fsp="echo 'Going to schema' && cd $FEWORK/schema && git pull && echo 'Updated schema locally' && echo 'Going back' && cd - && echo 'Back in: ' && pwd && frcenv flutter pub upgrade schema && fvm dart run build_runner build --delete-conflicting-outputs"
#alias dbrc="frcenv dart run build_runner clean"
# GIt stuff
alias gRmain='git fetch origin main && git reset --hard origin/main'
alias gMmain='git fetch origin main && git merge origin/main'
alias gRbeta='git fetch origin beta && git reset --hard origin/beta'
alias gpom="git pull origin main"
alias gpo="git pull origin"
alias gf="git fetch"
alias gfo="git fetch origin"
alias gfom="git fetch origin main"
alias gc="git checkout -"
alias hawk='git'
alias gcar="git commit --amend --reuse-message=HEAD"
alias gie="git commit -m 'chore: automatic commit' --allow-empty"
alias gdiff='git diff --color-words=. '
#alias gs='git switch $( (gh pr list --author "@me" --json title,headRefName --jq ".[] | [.title, .headRefName] | @tsv" ; git branch --sort=-committerdate --format="%(refname:short)" | grep -vE "^(TASK|ISSUE)") | fzf --height 20% --layout=reverse --border --ansi | cut -f2)'
alias gg="lazygit"
alias vg='EDITOR=vi lazygit'
alias zz='/opt/homebrew/bin/zellij attach resources'
alias zellij='/opt/homebrew/bin/zellij attach resources'
# opens lazygit in dir of symlink source, returns to curdir when closed
lzsym() {
  [ -z "$1" ] && echo "Usage: lzsym <filepath>" && return 1
  local orig_dir=$(dirname "$(realpath "$1")")
  local current_dir=$(pwd)
  cd "$orig_dir" && lazygit
  cd "$current_dir"
}

alias fedit='nvim $(fzf)'
alias mfy='markdownify'


# Zsh stuff
alias zs='source ~/.zshrc'
alias zsz='source ~/.config/zsh/zshrc'
alias zsa='source ~/.config/zsh/aliases'
alias zsf='source ~/.config/zsh/functionsrc'
alias zea='nvim ~/.config/zsh/aliases'
alias zef='nvim ~/.config/zsh/functionsrc'
alias ze='nvim ~/.zshrc'
alias zez='nvim ~/.config/zsh/zshrc'
alias claude='ANTHROPIC_API_KEY="" ~/.claude/local/claude'
alias gemini="GEMINI_API_KEY='' gemini"
alias gem='GEMINI_API_KEY='' gemini --yolo --checkpointing'
alias oc='EDITOR=/opt/homebrew/bin/nvim ANTHROPIC_API_KEY='' GEMINI_API_KEY='' OPENAI_API_KEY='' opencode --continue'
alias ac='OPENAI_API_KEY='' codex --search --dangerously-bypass-approvals-and-sandbox'
alias em='emacs -nw'
alias gmt='go mod tidy'
alias ccg='bunx ccusage'

mash(){
  git status --porcelain | egrep '^(DD|AU|UD|UA|DU|AA|UU)' | awk '{print $2}' | xargs $1
}
sourcenv(){
  [ -f .env ] && export $(grep -v "^#" .env | xargs)
}


# Detect which `ls` flavor is in use
if ls --color > /dev/null 2>&1; then # GNU `ls`
	colorflag="--color"
else # OS X `ls`
	colorflag="-G"
fi

# List all files colorized in long format, including dot files
alias la="ls -lahF ${colorflag}"


# Always use color output for `ls`
alias ls="command ls ${colorflag}"
export LS_COLORS='no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.avi=01;35:*.fli=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.ogg=01;35:*.mp3=01;35:*.wav=01;35:'


# Always enable colored `grep` output
# Note: `GREP_OPTIONS="--color=auto"` is deprecated, hence the alias usage.
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# Enable aliases to be sudo’ed
alias sudo='sudo '
alias serve="browser-sync start -s -f . --no-notify --host 192.168.1.14 --port 9000"

if uname -r | grep -q 'microsoft'; then
	alias emacsg='DISPLAY=:0 emacs'
fi
alias dotnet='DOTNET_CLI_TELEMETRY_OPTOUT=1 echo "Tele: off" && dotnet'
alias zellij='cat ~/.config/zellij/cope.md'


export OLD='/Users/mac/dev/tutero/flutter'
alias old='cd ~/dev/tutero/flutter'
alias oldre='cd ~/dev/tutero/flutter/resources'
alias oldle='cd ~/dev/tutero/flutter/learning'
alias oldsc='cd ~/dev/tutero/flutter/schools-app'
alias oldlp='cd ~/dev/tutero/flutter/learning-library/features/lesson_plan/'
alias oldws='cd ~/dev/tutero/flutter/learning-library/features/worksheets/'
alias oldll='cd ~/dev/tutero/flutter/learning-library'
alias oldcf='cd ~/dev/tutero/flutter/core-flutter'
alias oldlg='cd ~/dev/tutero/flutter/legacy-frontend/packages/core'
